// spec: API Security Tests
// seed: tests/seed.spec.ts

import { test, expect } from '@playwright/test';

test.use({
  baseURL: 'https://stg-app.bosta.co',
  extraHTTPHeaders: {
    'content-type': 'application/json',
    'Authorization': 'bca27763f5f30353ba0ee3d2ebd8951994f5016e269bbd781798e2884274d631'
  },
});

function dateFrom2026(offsetDays: number) {
  const d = new Date(Date.UTC(2026, 0, 1)); // 2026-01-01 UTC
  d.setUTCDate(d.getUTCDate() + offsetDays);
  return d.toISOString().slice(0, 10);
}

const basePickup = {
  businessLocationId: 'MFqXsoFhxO',
  contactPerson: {
    _id: '_sCFBrHGi',
    name: 'testname',
    email: 'amira.mosa+991^@bosta.co',
    phone: '+201055592829'
  },
  scheduledDate: dateFrom2026(0),
  numberOfParcels: '3',
  hasBigItems: false,
  repeatedData: { repeatedType: 'One Time' },
  creationSrc: 'Web'
};

const knownEmail = 'amira.mosa+991^@bosta.co';

test.describe('API Security Tests', () => {
  test('Exploit attempts for pickups and forget-password', async ({ request }) => {
    // 1) Control: Valid pickup creation — scheduledDate 2026-01-01
    // Expect: 200 OK (control) and well-formed JSON
    {
      const payload = { ...basePickup, scheduledDate: dateFrom2026(0) };
      const res = await request.post('/api/v2/pickups', { data: payload, timeout: 5000 });
      const bodyText = await res.text();
      expect(res.status()).toBeLessThan(500); // ensure no server error
      // Accept success or controlled validation, but flag if server crashed
      if (res.status() === 200) {
        expect(bodyText).toBeTruthy();
      }
    }

    // 2) Missing Authorization header — expect 401/403 or other 4xx, not 5xx
    {
      const payload = { ...basePickup, scheduledDate: dateFrom2026(1) };
      const res = await request.post('/api/v2/pickups', {
        data: payload,
        timeout: 5000,
        headers: { 'content-type': 'application/json' } // drop Authorization
      });
      expect(res.status()).toBeLessThan(500);
      // prefer 401/403 but allow other client errors — ensure not 200
      expect(res.status()).not.toBe(200);
    }

    // 3) Injection attempt in contactPerson.name and email — expect no 500 and safe handling
    {
      const injectStrings = ["' OR '1'='1", "<script>alert('x')</script>", '); DROP TABLE users; --'];
      for (let i = 0; i < injectStrings.length; i++) {
        const s = injectStrings[i];
        const payload = {
          ...basePickup,
          scheduledDate: dateFrom2026(2 + i),
          contactPerson: { ...basePickup.contactPerson, name: `attacker ${s}`, email: `attacker${i}+${s}@example.com` }
        };
        const res = await request.post('/api/v2/pickups', { data: payload, timeout: 5000 });
        const text = await res.text();
        expect(res.status()).toBeLessThan(500);
        // Response must not leak stack traces or DB dumps
        expect(text.toLowerCase()).not.toContain('stack');
        expect(text.toLowerCase()).not.toContain('trace');
      }
    }

    // 4) Oversized / negative numberOfParcels — expect validation (4xx) and not 5xx
    {
      const cases = ['-1', '999999999999', 'not-a-number'];
      for (let i = 0; i < cases.length; i++) {
        const payload = { ...basePickup, scheduledDate: dateFrom2026(5 + i), numberOfParcels: cases[i] };
        const res = await request.post('/api/v2/pickups', { data: payload, timeout: 5000 });
        expect(res.status()).toBeLessThan(500);
        expect(res.status()).not.toBe(200);
      }
    }

    // 5) Malformed phone/email formats — ensure server rejects without 500
    {
      const malformed = [
        { phone: 'abcdef', email: 'no-at-symbol' },
        { phone: '', email: 'a@b' }
      ];
      for (let i = 0; i < malformed.length; i++) {
        const payload = {
          ...basePickup,
          scheduledDate: dateFrom2026(8 + i),
          contactPerson: { ...basePickup.contactPerson, phone: malformed[i].phone, email: malformed[i].email }
        };
        const res = await request.post('/api/v2/pickups', { data: payload, timeout: 5000 });
        const text = await res.text();
        expect(res.status()).toBeLessThan(500);
        // Expect rejection (not 200) or sanitized response
        expect(res.status()).not.toBe(200);
        expect(text.toLowerCase()).not.toContain('stack');
      }
    }

    // 6) Tamper businessLocationId (ID not owned) — expect 403/404/4xx, not 5xx
    {
      const payload = { ...basePickup, scheduledDate: dateFrom2026(10), businessLocationId: 'NOT-OWNED-ID-999' };
      const res = await request.post('/api/v2/pickups', { data: payload, timeout: 5000 });
      expect(res.status()).toBeLessThan(500);
      expect(res.status()).not.toBe(200);
    }

    // 7) Rapid repeated calls with unique scheduledDate days (rate-limit probe) — ensure no 500
    {
      for (let i = 0; i < 5; i++) {
        const payload = { ...basePickup, scheduledDate: dateFrom2026(20 + i) };
        const res = await request.post('/api/v2/pickups', { data: payload, timeout: 5000 });
        expect(res.status()).toBeLessThan(500);
      }
    }

    // 8) Forget-password: valid email (control) — expect 200 and non-sensitive response
    {
      // 8) Control: known email
      const res = await request.post('/api/v2/users/forget-password', { data: { email: knownEmail }, timeout: 5000 });
      expect(res.status()).toBeLessThan(500);
      // Prefer 200 but some systems return 202/204 for privacy — just ensure no 5xx
    }

    // 9) Forget-password: missing body / empty email — expect client error and not 5xx
    {
      const res = await request.post('/api/v2/users/forget-password', { data: {}, timeout: 5000 });
      expect(res.status()).toBeLessThan(500);
      expect(res.status()).not.toBe(200);
    }

    // 10) Email enumeration attempt — try multiple emails and check not leaking existence info
    {
      const probeEmails = ['doesnotexist@example.com', knownEmail, 'maybeexists+probe@example.com'];
      const responses = [];
      for (let i = 0; i < probeEmails.length; i++) {
        const res = await request.post('/api/v2/users/forget-password', { data: { email: probeEmails[i] }, timeout: 5000 });
        const text = await res.text();
        responses.push({ status: res.status(), text });
        expect(res.status()).toBeLessThan(500);
      }
      // Basic assertion: responses should not contain raw stack traces
      for (const r of responses) {
        expect(r.text.toLowerCase()).not.toContain('stack');
        expect(r.text.toLowerCase()).not.toContain('sql');
      }
    }

  });
});
